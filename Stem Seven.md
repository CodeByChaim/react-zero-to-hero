# **üìå Step 7: State Management with Redux Toolkit**
### **Goal:**
- Manage **global state** with Redux Toolkit (RTK).
- Create a **slice** for managing authentication state.
- Use Redux **actions & reducers** to update the store.
- Integrate Redux with React components.

---

## **1Ô∏è‚É£ Install Dependencies**
```bash
npm install @reduxjs/toolkit react-redux
```
‚úÖ **`@reduxjs/toolkit`** ‚Üí Simplifies Redux state management.  
‚úÖ **`react-redux`** ‚Üí Connects Redux with React components.

---

## **2Ô∏è‚É£ Setup Redux Store**
üìå **Create `src/store/store.ts`:**
```tsx
import { configureStore } from "@reduxjs/toolkit";
import authReducer from "./authSlice";

export const store = configureStore({
  reducer: {
    auth: authReducer,
  },
});

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```
‚úÖ Central **Redux store** that manages state.  
‚úÖ Includes **auth slice** (to be created next).

---

## **3Ô∏è‚É£ Create an Authentication Slice**
üìå **Create `src/store/authSlice.ts`:**
```tsx
import { createSlice, PayloadAction } from "@reduxjs/toolkit";

interface AuthState {
  token: string | null;
  isAuthenticated: boolean;
}

const initialState: AuthState = {
  token: localStorage.getItem("authToken"),
  isAuthenticated: !!localStorage.getItem("authToken"),
};

const authSlice = createSlice({
  name: "auth",
  initialState,
  reducers: {
    login: (state, action: PayloadAction<string>) => {
      state.token = action.payload;
      state.isAuthenticated = true;
      localStorage.setItem("authToken", action.payload);
    },
    logout: (state) => {
      state.token = null;
      state.isAuthenticated = false;
      localStorage.removeItem("authToken");
    },
  },
});

export const { login, logout } = authSlice.actions;
export default authSlice.reducer;
```
‚úÖ **`createSlice()`** manages authentication state.  
‚úÖ `login(token)` updates Redux **and** stores token in `localStorage`.  
‚úÖ `logout()` clears Redux state **and** removes the token.

---

## **4Ô∏è‚É£ Provide Store to React App**
üìå **Modify `src/App.tsx`:**
```tsx
import React from "react";
import { Provider } from "react-redux";
import { store } from "./store/store";
import AppRouter from "./routes/Router";

const App: React.FC = () => {
  return (
    <Provider store={store}>
      <AppRouter />
    </Provider>
  );
};

export default App;
```
‚úÖ `Provider` wraps the app, **giving all components access to Redux state**.

---

## **5Ô∏è‚É£ Connect Login to Redux**
üìå **Modify `src/components/LoginForm.tsx`:**
```tsx
import React from "react";
import { useForm } from "react-hook-form";
import { yupResolver } from "@hookform/resolvers/yup";
import * as yup from "yup";
import { useDispatch } from "react-redux";
import { login } from "../store/authSlice";
import { useNavigate } from "react-router-dom";

interface LoginFormInputs {
  email: string;
  password: string;
}

const schema = yup.object({
  email: yup.string().email("Invalid email").required("Email is required"),
  password: yup.string().min(6, "Password must be at least 6 characters").required(),
});

const LoginForm: React.FC = () => {
  const dispatch = useDispatch();
  const navigate = useNavigate();

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormInputs>({ resolver: yupResolver(schema) });

  const onSubmit = async (data: LoginFormInputs) => {
    try {
      const response = await fakeApiLogin(data.email, data.password);
      dispatch(login(response.token));
      navigate("/dashboard");
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <div>
        <label>Email:</label>
        <input type="email" {...register("email")} />
        {errors.email && <p>{errors.email.message}</p>}
      </div>

      <div>
        <label>Password:</label>
        <input type="password" {...register("password")} />
        {errors.password && <p>{errors.password.message}</p>}
      </div>

      <button type="submit">Login</button>
    </form>
  );
};

// Fake API function (Replace with real API)
const fakeApiLogin = async (email: string, password: string) => {
  return new Promise<{ token: string }>((resolve) =>
    setTimeout(() => resolve({ token: "fake-jwt-token-12345" }), 1000)
  );
};

export default LoginForm;
```
‚úÖ **Replaces `useAuth()` with Redux `useDispatch()`**  
‚úÖ `dispatch(login(token))` updates **Redux store** and **localStorage**.

---

## **6Ô∏è‚É£ Protect Routes with Redux State**
üìå **Modify `src/routes/ProtectedRoute.tsx`:**
```tsx
import React from "react";
import { Navigate } from "react-router-dom";
import { useSelector } from "react-redux";
import { RootState } from "../store/store";

const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const isAuthenticated = useSelector((state: RootState) => state.auth.isAuthenticated);
  return isAuthenticated ? <>{children}</> : <Navigate to="/login" />;
};

export default ProtectedRoute;
```
‚úÖ **Uses Redux store** instead of `AuthContext`.  
‚úÖ Redirects **unauthenticated users** to `/login`.

---

## **7Ô∏è‚É£ Logout Using Redux**
üìå **Modify `src/pages/DashboardPage.tsx`:**
```tsx
import React from "react";
import { useDispatch } from "react-redux";
import { logout } from "../store/authSlice";
import { useNavigate } from "react-router-dom";

const DashboardPage: React.FC = () => {
  const dispatch = useDispatch();
  const navigate = useNavigate();

  return (
    <div>
      <h1>Dashboard</h1>
      <button onClick={() => { dispatch(logout()); navigate("/login"); }}>
        Logout
      </button>
    </div>
  );
};

export default DashboardPage;
```
‚úÖ Uses Redux **`dispatch(logout())`** to clear authentication.

---

## **8Ô∏è‚É£ Save This Step in GitHub**
```bash
git checkout -b step-7-redux-toolkit
git add .
git commit -m "Step 7: Implemented state management with Redux Toolkit"
git push origin step-7-redux-toolkit
```

---

## **‚úÖ Summary of What We Built**
| Feature | Implementation |
|---------|---------------|
| ‚úÖ Global Auth State | Redux Toolkit Slice (`authSlice.ts`) |
| ‚úÖ Token Storage | `localStorage.setItem("authToken", token)` |
| ‚úÖ Login with Redux | `dispatch(login(token))` |
| ‚úÖ Logout with Redux | `dispatch(logout())` |
| ‚úÖ Protected Routes | Redirect unauthenticated users |


---

# **üìå Step 7 (II): Enhancing Security: Using HttpOnly Cookies Instead of Local Storage**

## **üîπ Why Move from `localStorage` to HttpOnly Cookies?**
‚úÖ **More Secure** ‚Üí Cookies with `HttpOnly` & `Secure` flags **cannot be accessed** by JavaScript, preventing XSS attacks.  
‚úÖ **Automatic Handling** ‚Üí Browsers **send cookies automatically** with requests, reducing manual token management.  
‚úÖ **Better Compliance** ‚Üí Many security standards recommend **session-based authentication** over local storage.

---

## **1Ô∏è‚É£ Backend: Modify Authentication API to Use Cookies**

### **üîπ Install Dependencies**
Run the following in your Node.js/Express backend:
```bash
npm install cookie-parser cors express jsonwebtoken dotenv
```
‚úÖ **`cookie-parser`** ‚Üí Parses cookies from HTTP requests.  
‚úÖ **`jsonwebtoken`** ‚Üí Signs & verifies JWTs.

---

### **üîπ Modify Login API (`routes/auth.ts`)**
üìå **Set JWT in a `HttpOnly` cookie**
```ts
import express from "express";
import jwt from "jsonwebtoken";
import dotenv from "dotenv";

dotenv.config();
const router = express.Router();

router.post("/login", (req, res) => {
  const { email, password } = req.body;

  // Simulate user authentication (replace with real DB check)
  if (email === "test@example.com" && password === "password123") {
    const token = jwt.sign({ email }, process.env.JWT_SECRET as string, { expiresIn: "1h" });

    // Set HttpOnly Cookie
    res.cookie("authToken", token, {
      httpOnly: true, // ‚úÖ Prevents JavaScript access (XSS protection)
      secure: process.env.NODE_ENV === "production", // ‚úÖ Ensures HTTPS in production
      sameSite: "strict", // ‚úÖ Prevents CSRF attacks
      maxAge: 60 * 60 * 1000, // 1 hour
    });

    return res.json({ message: "Login successful" });
  }

  res.status(401).json({ error: "Invalid credentials" });
});

export default router;
```
‚úÖ **Stores JWT in a secure, HttpOnly cookie** instead of sending it to the frontend.  
‚úÖ Prevents **XSS attacks** by ensuring JavaScript **cannot** access the cookie.

---

## **2Ô∏è‚É£ Backend: Add Middleware to Protect Routes**
üìå **Modify `middleware/auth.ts`**
```ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";

export const authenticateUser = (req: Request, res: Response, next: NextFunction) => {
  const token = req.cookies.authToken; // ‚úÖ Read token from HttpOnly cookie

  if (!token) return res.status(401).json({ error: "Unauthorized" });

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET as string);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(403).json({ error: "Invalid token" });
  }
};
```
‚úÖ **Automatically verifies** JWT tokens in cookies for **secure authentication**.  
‚úÖ **No need** to manually store or send tokens in frontend requests.

---

## **3Ô∏è‚É£ Backend: Logout by Clearing the Cookie**
üìå **Modify `routes/auth.ts`**
```ts
router.post("/logout", (req, res) => {
  res.clearCookie("authToken", {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "strict",
  });

  res.json({ message: "Logged out successfully" });
});
```
‚úÖ Removes the JWT by **clearing the cookie**.  
‚úÖ **Prevents token leaks** after logout.

---

## **4Ô∏è‚É£ Frontend: Modify Login Request to Use Cookies**
üìå **Modify `src/store/authSlice.ts`**
```ts
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";

export const loginUser = createAsyncThunk("auth/login", async (credentials) => {
  await axios.post("/api/auth/login", credentials, { withCredentials: true });
  return true; // ‚úÖ No token needed, cookie is set automatically
});

export const logoutUser = createAsyncThunk("auth/logout", async () => {
  await axios.post("/api/auth/logout", { withCredentials: true });
  return false;
});

const authSlice = createSlice({
  name: "auth",
  initialState: { isAuthenticated: false },
  reducers: {},
  extraReducers: (builder) => {
    builder.addCase(loginUser.fulfilled, (state) => {
      state.isAuthenticated = true;
    });
    builder.addCase(logoutUser.fulfilled, (state) => {
      state.isAuthenticated = false;
    });
  },
});

export default authSlice.reducer;
```
‚úÖ `withCredentials: true` **ensures cookies are sent automatically** with requests.  
‚úÖ **No need to store JWT in localStorage** anymore.

---

## **5Ô∏è‚É£ Frontend: Check Authentication on Page Load**
üìå **Modify `src/hooks/useAuthCheck.ts`**
```ts
import { useEffect } from "react";
import { useDispatch } from "react-redux";
import axios from "axios";
import { loginUser } from "../store/authSlice";

export const useAuthCheck = () => {
  const dispatch = useDispatch();

  useEffect(() => {
    axios.get("/api/auth/validate", { withCredentials: true })
      .then(() => dispatch(loginUser()))
      .catch(() => console.log("Not authenticated"));
  }, [dispatch]);
};
```
‚úÖ **Sends a request on page load** to check if the cookie-based session is still valid.  
‚úÖ Ensures authentication state **persists across refreshes**.

---

## **6Ô∏è‚É£ Secure API Calls with Cookies**
üìå **Modify API Calls in `axios.ts`**
```ts
import axios from "axios";

const api = axios.create({
  baseURL: "/api",
  withCredentials: true, // ‚úÖ Ensures cookies are sent with every request
});

export default api;
```
‚úÖ Automatically **includes authentication cookies** in every request.

---

## **7Ô∏è‚É£ Save This Step in GitHub**
```bash
git checkout -b step-7-secure-auth-cookies
git add .
git commit -m "Step 7: Improved security using HttpOnly cookies"
git push origin step-7-secure-auth-cookies
```

---

## **‚úÖ Summary: What We Built**
| Feature | Implementation |
|---------|---------------|
| ‚úÖ Store JWT Securely | `HttpOnly` & `Secure` cookie instead of `localStorage` |
| ‚úÖ Auto-Login | Session persists with cookie on page reload |
| ‚úÖ Logout | Removes cookie using `res.clearCookie()` |
| ‚úÖ API Calls | Cookies sent automatically with `withCredentials: true` |
